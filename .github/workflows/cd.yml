---
name: CD
on: workflow_dispatch
# on:
#   push:
#     branches: [ main ]
jobs:
  build-push-gcr:
    name: Build and Push to GCP
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: sampleapp
      PROJECT_ID: driver-297313
    outputs:
      IMAGE_NAME: ${{ env.IMAGE_NAME }}
      IMAGE_TAG: ${{ steps.docker-push.output.git_tag }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - id: 'gcp-auth'
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

    - name: Set up Cloud SDK (Prod)
      uses: google-github-actions/setup-gcloud@v0
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Build package
      run: mvn -f pom.xml  package

    - name: Publish package
      run: mvn deploy

  #   - name: Build Docker Image
  #     run: docker build -t $IMAGE_NAME:latest .

  #   - name: Configure Docker Client
  #     run: |-
  #       gcloud auth configure-docker --quiet

  #   - name: Push Docker Image to Container Registry (GCR)
  #     id: docker-push
  #     env:
  #       GIT_TAG: v1.0.0
  #     run: |-
  #       docker tag $IMAGE_NAME:latest gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
  #       docker tag $IMAGE_NAME:latest gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG
  #       docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
  #       docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG
  #       echo "::set-output name=git_tag::$GIT_TAG"

  # update-chart:
  #   name: Update Helm Chart Values file
  #   runs-on: ubuntu-latest
  #   needs: build-push-gcr
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #       with:
  #         repository: 'aventiortechnology/CRIO-SiteApp'
  #         ref: 'main'
  #         path: '${{needs.build-push-gcr.outputs.IMAGE_NAME}}'
  #         token: '${{ secrets.PAT }}'

  #     - name: Update values.yaml
  #       uses: fjogeleit/yaml-update-action@main
  #       with:
  #         valueFile: 'values.yaml'
  #         propertyPath: 'image.tag'
  #         value: ${{needs.build-push-gcr.outputs.IMAGE_TAG}}
  #         repository: 'aventiortechnology/CRIO-SiteApp'
  #         commitChange: true